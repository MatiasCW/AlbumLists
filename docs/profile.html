<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/style.css">
    <title>User Profile</title>
    <header>
        <div class="container">
            <!-- Logo as a link to index.html -->
            <div class="logo">
                <a href="index.html">
                    <img src="media/logo.png" alt="Logo">
                </a>
            </div>
            <h1>Sounada</h1>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="list.html">List</a></li>
                    <li><a href="rankings.html">Rankings</a></li>
                    <li><a href="search.html">Search</a></li>
                </ul>
                <div class="auth-section">
                    <span id="userDisplay"></span> <!-- Username (if logged in) -->
                    <div id="authButtons">
                        <a href="signup.html">Sign Up</a>
                        <a href="login.html">Login</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>
</head>
<body>
    <!-- Background container -->
    <div id="background-container"></div>

    <!-- Profile container -->
    <div class="profile-container">
        <!-- Profile Picture Section -->
        <div class="profile-picture">
            <div class="username"></div> 
            <img id="profile-image" src="https://via.placeholder.com/150" alt="Profile Picture">
            <input type="file" id="file-input" accept="image/*">
            <button class="upload-btn" id="change-pfp-btn">
                Change Avatar
            </button>
            <br>
            <button class="upload-btn" id="change-bg-btn">
                Change Background
            </button>
        </div>

        <!-- Content Section -->
        <div class="content">
            <!-- List Button -->
            <button id="list-btn">List</button>
        </div>
    </div>

    <!-- Modal for selecting profile picture -->
    <div id="pfp-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Choose a Profile Picture</h2>
            <div id="pfp-options" class="image-options">
                <!-- Predefined profile pictures will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Modal for selecting background -->
    <div id="bg-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Choose a Background</h2>
            <div id="bg-options" class="image-options">
                <!-- Predefined backgrounds will be added here dynamically -->
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./script/firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Get the UID from the query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');

        // Elements
        const usernameElement = document.querySelector('.username');
        const profileImage = document.getElementById('profile-image');
        const backgroundContainer = document.getElementById('background-container');
        const pfpModal = document.getElementById('pfp-modal');
        const bgModal = document.getElementById('bg-modal');
        const pfpOptions = document.getElementById('pfp-options');
        const bgOptions = document.getElementById('bg-options');
        const changePfpBtn = document.getElementById('change-pfp-btn');
        const changeBgBtn = document.getElementById('change-bg-btn');

        // Predefined profile pictures and backgrounds
        const profilePictures = Array.from({ length: 20 }, (_, i) => `/profile-pictures/pfp${i + 1}.jpg`);
        const backgrounds = Array.from({ length: 20 }, (_, i) => `/backgrounds/bg${i + 1}.jpg`);

        // Load user data
        const loadUserData = async () => {
            if (!uid) {
                alert("User ID not found.");
                window.location.href = "index.html";
                return;
            }

            const userDoc = await getDoc(doc(db, 'users', uid));
            if (userDoc.exists()) {
                const { username, profilePicture, backgroundImage } = userDoc.data();
                usernameElement.textContent = username;
                profileImage.src = profilePicture || "https://via.placeholder.com/150";
                backgroundContainer.style.backgroundImage = `url('${backgroundImage || "https://via.placeholder.com/1920x1080"}')`;
            } else {
                alert("User not found.");
                window.location.href = "index.html";
            }
        };

        // Open profile picture modal
        changePfpBtn.addEventListener('click', () => {
            pfpModal.style.display = "block";
            loadPfpOptions();
        });

        // Open background modal
        changeBgBtn.addEventListener('click', () => {
            bgModal.style.display = "block";
            loadBgOptions();
        });

        // Close modals
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                pfpModal.style.display = "none";
                bgModal.style.display = "none";
            });
        });

        // Load profile picture options
        const loadPfpOptions = () => {
            pfpOptions.innerHTML = profilePictures
                .map((pfp, index) => `
                    <div class="image-option" data-pfp="${pfp}">
                        <img src="${pfp}" alt="Profile Picture ${index + 1}">
                    </div>
                `)
                .join('');

            document.querySelectorAll('#pfp-options .image-option').forEach(option => {
                option.addEventListener('click', async () => {
                    const selectedPfp = option.getAttribute('data-pfp');
                    profileImage.src = selectedPfp;
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), { profilePicture: selectedPfp });
                    pfpModal.style.display = "none";
                });
            });
        };

        // Load background options
        const loadBgOptions = () => {
            bgOptions.innerHTML = backgrounds
                .map((bg, index) => `
                    <div class="image-option" data-bg="${bg}">
                        <img src="${bg}" alt="Background ${index + 1}">
                    </div>
                `)
                .join('');

            document.querySelectorAll('#bg-options .image-option').forEach(option => {
                option.addEventListener('click', async () => {
                    const selectedBg = option.getAttribute('data-bg');
                    backgroundContainer.style.backgroundImage = `url('${selectedBg}')`;
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), { backgroundImage: selectedBg });
                    bgModal.style.display = "none";
                });
            });
        };

        // Initialize page
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
            loadUserData();
        });
    </script>
</body>
</html>